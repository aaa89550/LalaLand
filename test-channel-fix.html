<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨Šæ¯éŒ¯é »é“å•é¡Œä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .fix-details {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
        }
        .problem-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .solution-item {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
        }
        .code-snippet {
            background: #f1f3f4;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ è¨Šæ¯éŒ¯é »é“å•é¡Œä¿®å¾©å ±å‘Š</h1>
        
        <div class="fix-details">
            <h2>å•é¡Œæè¿°</h2>
            <p><strong>åŸå•é¡Œï¼š</strong>ç”¨çš„äººè®Šå¤šå¾Œï¼Œè¨Šæ¯é¡¯ç¤ºéŒ¯é »é“çš„ç‹€æ³å¤§å¢ï¼Œé›–ç„¶é‡æ•´å°±æœƒä¸è¦‹ï¼Œä»£è¡¨å¯«å…¥æ²’å•é¡Œï¼Œä½†æå–æœ‰éŒ¯èª¤ã€‚</p>
        </div>

        <h2>ğŸ” å•é¡ŒåŸå› åˆ†æ</h2>
        
        <div class="problem-item">
            <h3>1. ç¼ºä¹é »é“é©—è­‰æ©Ÿåˆ¶</h3>
            <p><code>appendMessage</code> å‡½æ•¸æ²’æœ‰æª¢æŸ¥è¨Šæ¯æ˜¯å¦å±¬æ–¼ç•¶å‰é »é“ï¼Œä»»ä½•ç›£è½å™¨éƒ½å¯ä»¥å¾€èŠå¤©å€åŸŸæ·»åŠ è¨Šæ¯ã€‚</p>
        </div>
        
        <div class="problem-item">
            <h3>2. å¤šé‡ç›£è½å™¨è¡çª</h3>
            <p>å…¨åŸŸç§è¨Šç›£è½å™¨ä¸€ç›´åœ¨é‹è¡Œï¼Œå³ä½¿åœ¨ç¾¤çµ„èŠå¤©ä¸­ä¹Ÿæœƒå˜—è©¦é¡¯ç¤ºç§è¨Šè¨Šæ¯ã€‚</p>
        </div>
        
        <div class="problem-item">
            <h3>3. ç‹€æ…‹æœªå®Œå…¨æ¸…ç†</h3>
            <p>åˆ‡æ›é »é“æ™‚ <code>renderedMessageIds</code> å’Œç›¸é—œç‹€æ…‹è®Šæ•¸æ²’æœ‰å®Œå…¨é‡ç½®ã€‚</p>
        </div>

        <h2>âœ… ä¿®å¾©æ–¹æ¡ˆ</h2>
        
        <div class="solution-item">
            <h3>1. æ–°å¢é »é“é©—è­‰æ©Ÿåˆ¶</h3>
            <p>ä¿®æ”¹ <code>appendMessage</code> å‡½æ•¸ï¼ŒåŠ å…¥ <code>sourceChannel</code> åƒæ•¸ï¼š</p>
            <div class="code-snippet">
function appendMessage(msg, msgId, sourceChannel = null) {
  // é©—è­‰è¨Šæ¯æ˜¯å¦å±¬æ–¼ç•¶å‰é »é“ï¼Œé˜²æ­¢éŒ¯é »é“é¡¯ç¤º
  if (sourceChannel) {
    const isGroupMessage = sourceChannel.startsWith('group_');
    const isPrivateMessage = sourceChannel.startsWith('private_') || sourceChannel.includes('_');
    
    if (currentChat.startsWith('group_') && !isGroupMessage) {
      console.log('âš ï¸ è·³ééç¾¤çµ„è¨Šæ¯åœ¨ç¾¤çµ„é »é“ä¸­é¡¯ç¤º');
      return;
    }
    
    if (currentChat === 'private' && !isPrivateMessage) {
      console.log('âš ï¸ è·³ééç§è¨Šè¨Šæ¯åœ¨ç§è¨Šé »é“ä¸­é¡¯ç¤º');
      return;
    }
  }
  // ... å…¶é¤˜æ¸²æŸ“é‚è¼¯
}
            </div>
        </div>
        
        <div class="solution-item">
            <h3>2. ç›£è½å™¨é »é“æ¨™è­˜</h3>
            <p>æ‰€æœ‰ç›£è½å™¨å‘¼å« <code>appendMessage</code> æ™‚éƒ½åŠ å…¥é »é“æ¨™è­˜ï¼š</p>
            <div class="code-snippet">
// ç¾¤çµ„èŠå¤©ç›£è½å™¨
appendMessage(snap.val(), msgId, `group_${room}`);

// ç§è¨Šç›£è½å™¨  
appendMessage(msg, msgId, `private_${roomId}`);

// æŠ•ç¥¨æ›´æ–°ç›£è½å™¨
appendMessage(msg, msgId, `group_${room}`);
            </div>
        </div>
        
        <div class="solution-item">
            <h3>3. æ”¹å–„ç‹€æ…‹æ¸…ç†</h3>
            <p>å¼·åŒ– <code>clearChat</code> å’Œ <code>stopAllListeners</code> å‡½æ•¸ï¼š</p>
            <div class="code-snippet">
function clearChat() {
  document.getElementById('chat').innerHTML = '';
  renderedMessageIds.clear();
  messageMap = {}; // ä¹Ÿæ¸…ç©ºè¨Šæ¯æ˜ å°„
  console.log('ğŸ§¹ èŠå¤©å…§å®¹å·²æ¸…ç©ºï¼Œå·²æ¸²æŸ“è¨Šæ¯IDå·²é‡ç½®');
}

function stopAllListeners() {
  // ... æ¸…ç†æ‰€æœ‰ç›£è½å™¨
  currentPrivateRoomId = null;
  currentPrivateUid = null; // é‡ç½®æ‰€æœ‰ç‹€æ…‹è®Šæ•¸
  console.log('ğŸ§¹ æ‰€æœ‰ç›£è½å™¨å·²æ¸…ç†å®Œæˆ');
}
            </div>
        </div>
        
        <div class="solution-item">
            <h3>4. åˆ‡æ›é »é“æ™‚å¼·åˆ¶æ¸…ç†</h3>
            <p>ä¿®æ”¹ <code>switchChatRoom</code> å‡½æ•¸ï¼Œç¢ºä¿åˆ‡æ›å‰æ¸…ç†ï¼š</p>
            <div class="code-snippet">
window.switchChatRoom = function(room) {
  console.log('ğŸ”„ åˆ‡æ›èŠå¤©å®¤:', room);
  
  // å…ˆåœæ­¢æ‰€æœ‰ç›£è½å™¨ï¼Œç¢ºä¿ä¹¾æ·¨åˆ‡æ›
  stopAllListeners();
  
  // ... å…¶é¤˜åˆ‡æ›é‚è¼¯
};
            </div>
        </div>

        <h2>ğŸ“Š é æœŸä¿®å¾©æ•ˆæœ</h2>
        
        <div class="test-result success">
            <h3>âœ… å•é¡Œè§£æ±º</h3>
            <ul>
                <li><strong>é˜²æ­¢éŒ¯é »é“é¡¯ç¤ºï¼š</strong>è¨Šæ¯åªæœƒåœ¨å°æ‡‰çš„é »é“ä¸­é¡¯ç¤º</li>
                <li><strong>æ¸…ç†ç›£è½å™¨è¡çªï¼š</strong>åˆ‡æ›é »é“æ™‚å®Œå…¨æ¸…ç†èˆŠç›£è½å™¨</li>
                <li><strong>ç‹€æ…‹ä¸€è‡´æ€§ï¼š</strong>ç¢ºä¿ UI ç‹€æ…‹èˆ‡å¯¦éš›é »é“ä¸€è‡´</li>
                <li><strong>æ•ˆèƒ½æå‡ï¼š</strong>æ¸›å°‘ä¸å¿…è¦çš„ç›£è½å™¨å’Œæ¸²æŸ“</li>
            </ul>
        </div>

        <div class="test-result warning">
            <h3>âš ï¸ æ¸¬è©¦å»ºè­°</h3>
            <ol>
                <li>å¤šç”¨æˆ¶åŒæ™‚åœ¨ä¸åŒé »é“ç™¼é€è¨Šæ¯</li>
                <li>å¿«é€Ÿåˆ‡æ›ç¾¤çµ„èŠå¤©å®¤å’Œç§è¨Š</li>
                <li>æª¢æŸ¥è¨Šæ¯æ˜¯å¦åªå‡ºç¾åœ¨æ­£ç¢ºçš„é »é“</li>
                <li>è§€å¯Ÿ console æ—¥èªŒç¢ºèªé »é“é©—è­‰ç”Ÿæ•ˆ</li>
                <li>æ¸¬è©¦æŠ•ç¥¨åŠŸèƒ½åœ¨æ­£ç¢ºé »é“æ›´æ–°</li>
            </ol>
        </div>

        <h2>ğŸ”§ æŠ€è¡“æ”¹é€²ç´°ç¯€</h2>
        
        <div class="code-snippet">
ä¸»è¦ä¿®æ”¹çš„å‡½æ•¸ï¼š
- appendMessage()          - æ–°å¢é »é“é©—è­‰é‚è¼¯
- clearChat()             - å®Œå…¨é‡ç½®ç‹€æ…‹
- stopAllListeners()      - æ¸…ç†æ‰€æœ‰ç›£è½å™¨å’Œç‹€æ…‹
- loadGroupChat()         - åŠ å…¥é »é“æ¨™è­˜
- loadSpecificPrivateChat() - åŠ å…¥é »é“æ¨™è­˜
- listenToVoteUpdates()   - åŠ å…¥é »é“é©—è­‰
- switchChatRoom()        - å¼·åˆ¶æ¸…ç†å¾Œåˆ‡æ›
- startGlobalPrivateMessageMonitoring() - é˜²é‡è¤‡å•Ÿå‹•
        </div>

        <h2>ğŸ“ˆ ç›£æ§è¦é»</h2>
        <ul>
            <li>è§€å¯Ÿ console ä¸­æ˜¯å¦å‡ºç¾ "è·³ééç¾¤çµ„è¨Šæ¯" æˆ– "è·³ééç§è¨Šè¨Šæ¯" çš„æ—¥èªŒ</li>
            <li>ç¢ºèªåˆ‡æ›é »é“æ™‚èƒ½çœ‹åˆ° "æ‰€æœ‰ç›£è½å™¨å·²æ¸…ç†å®Œæˆ" çš„æ—¥èªŒ</li>
            <li>æª¢æŸ¥é«˜ä½µç™¼æƒ…æ³ä¸‹æ˜¯å¦é‚„æœ‰éŒ¯é »é“é¡¯ç¤º</li>
            <li>é©—è­‰æŠ•ç¥¨æ›´æ–°æ˜¯å¦åªåœ¨å°æ‡‰çš„ç¾¤çµ„é »é“ç”Ÿæ•ˆ</li>
        </ul>
    </div>
</body>
</html>
